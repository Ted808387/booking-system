<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易預約系統 (Vue.js 版本)</title>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; padding: 20px; background-color: #f4f7f6; }
        #app { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .booking-form { max-width: 500px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .booking-form h3 { margin-top: 0; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .time-slots { text-align: center; }
        .time-slots button { margin: 5px; padding: 10px 15px; border: 1px solid #ccc; background: #fff; cursor: pointer; border-radius: 4px; transition: all 0.2s ease-in-out; }
        .time-slots button:hover { background: #e9ecef; }
        .time-slots button.selected { background: #007bff; color: #fff; border-color: #007bff; }
        .time-slots button:disabled { background: #eee; cursor: not-allowed; opacity: 0.6; }
        button[type="submit"] { width: 100%; padding: 12px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
        button[type="submit"]:hover { background: #218838; }
    </style>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src='https://unpkg.com/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>

    <div id="app">
        <h2 style="text-align: center;">預約日曆</h2>
        <div id='calendar'></div>

        <div v-if="selectedDate" class="booking-form">
            <h3>預約 {{ selectedDate }}</h3>
            
            <div class="time-slots">
                <h4>選擇時段</h4>
                <template v-if="availableTimeSlots.length > 0">
                    <button
                        v-for="slot in availableTimeSlots"
                        :key="slot.time"
                        @click="selectTime(slot.time)"
                        :class="{ 'selected': booking.time === slot.time }"
                        :disabled="slot.isBooked"
                        type="button"
                    >
                        {{ slot.time }}
                    </button>
                </template>
                <p v-else>{{ timeSlotMessage }}</p>
            </div>
            <hr/>

            <form @submit.prevent="submitBooking">
                <div class="form-group">
                    <label for="service">選擇服務項目</label>
                    <select id="service" v-model="booking.service" required>
                        <option v-for="service in services" :key="service.name" :value="service.name">
                            {{ service.name }} ({{ service.duration }}分鐘)
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="name">姓名</label>
                    <input type="text" id="name" v-model.trim="booking.name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" v-model.trim="booking.email" required>
                </div>
                <div class="form-group">
                    <label for="phone">電話</label>
                    <input type="tel" id="phone" v-model.trim="booking.phone" required>
                </div>
                <button type="submit">確認預約</button>
            </form>
        </div>
    </div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                GAS_URL: 'https://script.google.com/macros/s/AKfycbwcL-hZVaoN5a9p3Ms6IsDEj1NrqHzIT7ddV7tsHlomdUM59D6wSLDfloZqPwArGlXl/exec',
                services: [],
                bookedTimes: [],
                availableSlotsConfig: [],
                calendar: null,
                selectedDate: null,
                booking: { 
                    date: '',
                    time: '',
                    service: '',
                    name: '',
                    email: '',
                    phone: ''
                },
            }
        },
        computed: {
            availableTimeSlots() {
                if (!this.selectedDate) return [];
                const dayOfWeekForSheet = new Date(this.selectedDate).getDay() + 1;

                const daySlotsConfig = this.availableSlotsConfig.filter(
                    s => s.day == dayOfWeekForSheet
                );

                if (daySlotsConfig.length === 0) return [];

                const allSlots = [];
                daySlotsConfig.forEach(slot => {
                    let currentTime = new Date(`${this.selectedDate}T${slot.start}`);
                    const endTime = new Date(`${this.selectedDate}T${slot.end}`);
                    
                    while (currentTime < endTime) {
                        const timeStr = currentTime.toTimeString().substring(0, 5);
                        const fullDateTimeStr = `${this.selectedDate}T${timeStr}`;

                        allSlots.push({
                            time: timeStr,
                            isBooked: this.bookedTimes.includes(fullDateTimeStr)
                        });

                        currentTime.setMinutes(currentTime.getMinutes() + 30);
                    }
                });
                return allSlots;
            },
            timeSlotMessage() {
                if (!this.selectedDate) return '';
                const available = this.availableTimeSlots.some(slot => !slot.isBooked);
                if (this.availableTimeSlots.length === 0) {
                    return '本日無開放預約。';
                } else if (!available) {
                    return '本日時段皆已約滿。';
                }
                return '';
            }
        },
        methods: {
            showNotification(icon, title, text) {
                Swal.fire({
                    icon: icon,
                    title: title,
                    text: text,
                    timer: 2500,
                    timerProgressBar: true,
                    showConfirmButton: false,
                });
            },
            async fetchInitialData() {
                try {
                    const response = await fetch(`${this.GAS_URL}?action=getInitialData`);
                    const data = await response.json();
                    if (data.services) {
                        this.services = data.services;
                        this.bookedTimes = data.bookedTimes;
                        this.availableSlotsConfig = data.availableSlots;
                        
                        if (this.services.length > 0) {
                            this.booking.service = this.services[0].name;
                        }
                    } else {
                        throw new Error(data.message || '後端資料格式不正確');
                    }
                } catch (error) {
                    console.error('獲取初始資料失敗:', error);
                    this.showNotification('error', '載入失敗', '無法獲取預約資料，請檢查後端是否部署成功或網路連線。');
                }
            },
            initializeCalendar() {
                const calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'zh-tw',
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek'
                    },
                    dateClick: this.handleDateClick
                });
                this.calendar.render();
            },
            handleDateClick(info) {	
								console.log(info)
                this.selectedDate = info.dateStr;
                this.booking.date = info.dateStr;
                this.booking.time = '';
            },
            selectTime(time) {
                this.booking.time = time;
            },
            async submitBooking() {
                if (!this.booking.time) {
                    this.showNotification('warning', '提示', '請先選擇一個預約時段！');
                    return;
                }
                
                Swal.fire({
                    title: '正在提交預約...',
                    text: '請稍候',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                try {
                    const response = await fetch(this.GAS_URL, {
                        method: 'POST',
                        body: new URLSearchParams(this.booking),
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        Swal.close();
                        this.showNotification('success', '預約成功！', '我們將盡快與您確認，謝謝。');
                        
                        this.bookedTimes.push(`${this.booking.date}T${this.booking.time}`);
                        this.booking.name = '';
                        this.booking.email = '';
                        this.booking.phone = '';
                        this.selectedDate = null;
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    Swal.close();
                    this.showNotification('error', '預約失敗', error.message);
                }
            }
        },
        mounted() {
            this.fetchInitialData();
            this.initializeCalendar();
        }
    }).mount('#app');
</script>

</body>
</html>