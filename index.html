<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易預約系統 (Vue.js 版本)</title>

    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; }
        #app { max-width: 900px; margin: 0 auto; }
        .booking-form { max-width: 500px; margin: 20px auto; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .booking-form h3 { margin-top: 0; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; }
        .time-slots button { margin: 5px; padding: 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
        .time-slots button.selected { background: #007bff; color: #fff; }
        .time-slots button:disabled { background: #eee; cursor: not-allowed; }
        button[type="submit"] { width: 100%; padding: 10px; background: #28a745; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        .message { margin-top: 15px; text-align: center; padding: 10px; border-radius: 5px; }
        .message.success { color: #155724; background-color: #d4edda; border-color: #c3e6cb; }
        .message.error { color: #721c24; background-color: #f8d7da; border-color: #f5c6cb; }
    </style>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src='https://unpkg.com/fullcalendar@6.1.11/index.global.min.js'></script>
</head>
<body>

    <div id="app">
        <h2>預約日曆</h2>
        <div id='calendar'></div>

        <div v-if="selectedDate" class="booking-form">
            <h3>預約 {{ selectedDate }}</h3>
            
            <div class="time-slots">
                <h4>選擇時段</h4>
                <template v-if="availableTimeSlots.length > 0">
                    <button
                        v-for="slot in availableTimeSlots"
                        :key="slot.time"
                        @click="selectTime(slot.time)"
                        :class="{ 'selected': booking.time === slot.time }"
                        :disabled="slot.isBooked"
                        type="button"
                    >
                        {{ slot.time }}
                    </button>
                </template>
                <p v-else>{{ timeSlotMessage }}</p>
            </div>
            <hr/>

            <form @submit.prevent="submitBooking">
                <div class="form-group">
                    <label for="service">選擇服務項目</label>
                    <select id="service" v-model="booking.service" required>
                        <option v-for="service in services" :key="service.name" :value="service.name">
                            {{ service.name }} ({{ service.duration }}分鐘)
                        </option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="name">姓名</label>
                    <input type="text" id="name" v-model.trim="booking.name" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" v-model.trim="booking.email" required>
                </div>
                <div class="form-group">
                    <label for="phone">電話</label>
                    <input type="tel" id="phone" v-model.trim="booking.phone" required>
                </div>
                <button type="submit">確認預約</button>
                
                <div v-if="message.text" :class="['message', message.type]">
                    {{ message.text }}
                </div>
            </form>
        </div>
    </div>

<script>
    const { createApp } = Vue;

    createApp({
        // 1. data: 應用程式的狀態管理中心
        data() {
            return {
                GAS_URL: 'https://script.google.com/macros/s/AKfycbwcL-hZVaoN5a9p3Ms6IsDEj1NrqHzIT7ddV7tsHlomdUM59D6wSLDfloZqPwArGlXl/exec',
                services: [],
                bookedTimes: [],
                availableSlotsConfig: [],
                calendar: null,
                selectedDate: null, // 用來控制表單顯示
                booking: { // 將所有表單欄位集中管理
                    date: '',
                    time: '',
                    service: '',
                    name: '',
                    email: '',
                    phone: ''
                },
                message: { text: '', type: '' } // success 或 error
            }
        },
        // 2. computed: 根據 data 自動計算衍伸的資料
        // 2. computed: 根據 data 自動計算衍伸的資料
        computed: {
            availableTimeSlots() {
                if (!this.selectedDate) return [];

                // *** 關鍵修正：直接將 JS 的星期 (0-6) 加 1，對應到試算表的 (1-7) ***
                const dayOfWeekForSheet = new Date(this.selectedDate).getDay() + 1;

                const daySlotsConfig = this.availableSlotsConfig.filter(
                    s => s.day == dayOfWeekForSheet
                );

                if (daySlotsConfig.length === 0) return [];

                const allSlots = [];
                daySlotsConfig.forEach(slot => {
                    let currentTime = new Date(`${this.selectedDate}T${slot.start}`);
                    const endTime = new Date(`${this.selectedDate}T${slot.end}`);
                    
                    while (currentTime < endTime) {
                        const timeStr = currentTime.toTimeString().substring(0, 5);
                        const fullDateTimeStr = `${this.selectedDate}T${timeStr}`;

                        allSlots.push({
                            time: timeStr,
                            isBooked: this.bookedTimes.includes(fullDateTimeStr)
                        });

                        currentTime.setMinutes(currentTime.getMinutes() + 30); // 每半小時一個時段
                    }
                });
                return allSlots;
            },
            timeSlotMessage() {
                if (!this.selectedDate) return '';
                const available = this.availableTimeSlots.some(slot => !slot.isBooked);
                if (this.availableTimeSlots.length === 0) {
                    return '本日無開放預約。';
                } else if (!available) {
                    return '本日時段皆已約滿。';
                }
                return '';
            }
        },
        // 3. methods: 放置所有事件處理函式
        methods: {
            async fetchInitialData() {
                try {
                    const response = await fetch(`${this.GAS_URL}?action=getInitialData`);
                    const data = await response.json();
                    if (data.services) {
                        this.services = data.services;
                        this.bookedTimes = data.bookedTimes;
                        this.availableSlotsConfig = data.availableSlots;
                        
                        // 預設選中第一個服務
                        if (this.services.length > 0) {
                            this.booking.service = this.services[0].name;
                        }
                    } else {
                        throw new Error('後端資料格式不正確');
                    }
                } catch (error) {
                    console.error('獲取初始資料失敗:', error);
                    this.message = { text: '系統載入失敗，請稍後再試。', type: 'error' };
                }
            },
            initializeCalendar() {
                const calendarEl = document.getElementById('calendar');
                this.calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    locale: 'zh-tw',
                    headerToolbar: { /* ... */ },
                    dateClick: this.handleDateClick
                });
                this.calendar.render();
            },
            handleDateClick(info) {
                this.selectedDate = info.dateStr;
                this.booking.date = info.dateStr;
                this.booking.time = ''; // 重置選擇的時間
                this.message.text = ''; // 清除舊訊息
            },
            selectTime(time) {
                this.booking.time = time;
            },
            async submitBooking() {
                if (!this.booking.time) {
                    this.message = { text: '請先選擇一個時段！', type: 'error' };
                    return;
                }

                this.message = { text: '提交中...', type: '' };

                try {
                    const response = await fetch(this.GAS_URL, {
                        method: 'POST',
                        body: new URLSearchParams(this.booking),
                        // body: JSON.stringify(this.booking),
                        // headers: { 'Content-Type': 'application/json' },
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        this.message = { text: '預約成功！我們將盡快與您確認。', type: 'success' };
                        // 成功後更新已預約時間，並重置表單
                        this.bookedTimes.push(`${this.booking.date}T${this.booking.time}`);
                        // 簡單重置
                        this.booking.name = '';
                        this.booking.email = '';
                        this.booking.phone = '';
                        this.selectedDate = null; // 隱藏表單
                    } else {
                        throw new Error(result.message);
                    }
                } catch (error) {
                    this.message = { text: `預約失敗：${error.message}`, type: 'error' };
                }
            }
        },
        // 4. mounted: Vue 實例掛載到頁面後執行的鉤子函式
        async mounted() {
            await this.fetchInitialData();
            this.initializeCalendar();
        }
    }).mount('#app');
</script>

</body>
</html>